
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>qharv.seed.qmcpack_in &#8212; qharv 0.0.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">qharv 0.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for qharv.seed.qmcpack_in</h1><div class="highlight"><pre>
<span></span><span class="c1"># Author: Yubo &quot;Paul&quot; Yang</span>
<span class="c1"># Email: yubo.paul.yang@gmail.com</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">from</span> <span class="nn">lxml</span> <span class="k">import</span> <span class="n">etree</span>

<span class="kn">from</span> <span class="nn">qharv.reel</span> <span class="k">import</span> <span class="n">mole</span>
<span class="kn">from</span> <span class="nn">qharv.seed</span> <span class="k">import</span> <span class="n">xml</span><span class="p">,</span> <span class="n">xml_examples</span>

<span class="c1"># =============== level 0: build input from scratch ===============</span>
<div class="viewcode-block" id="assemble_project"><a class="viewcode-back" href="../../../qharv.seed.html#qharv.seed.qmcpack_in.assemble_project">[docs]</a><span class="k">def</span> <span class="nf">assemble_project</span><span class="p">(</span><span class="n">nodel</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;qmc&#39;</span><span class="p">,</span> <span class="n">series</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; assemble QMCPACK input using a list of xml nodes</span>

<span class="sd">  usually nodel=[qmcsystem, qmc]</span>

<span class="sd">  Args:</span>
<span class="sd">    nodel (list): a list of xml node (lxml.Element)</span>
<span class="sd">    name (str, optional): project name, default &#39;qmc&#39;</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">qsim</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;simulation&#39;</span><span class="p">)</span>
  <span class="n">proj</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;project&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;series&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">series</span><span class="p">)})</span>
  <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="p">[</span><span class="n">proj</span><span class="p">]</span><span class="o">+</span><span class="n">nodel</span><span class="p">:</span>
    <span class="n">qsim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
  <span class="n">doc</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">ElementTree</span><span class="p">(</span><span class="n">qsim</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">doc</span></div>

<div class="viewcode-block" id="simulationcell_from_axes"><a class="viewcode-back" href="../../../qharv.seed.html#qharv.seed.qmcpack_in.simulationcell_from_axes">[docs]</a><span class="k">def</span> <span class="nf">simulationcell_from_axes</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">bconds</span><span class="o">=</span><span class="s1">&#39;p p p&#39;</span><span class="p">,</span> <span class="n">rckc</span><span class="o">=</span><span class="mf">15.</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; construct the &lt;simulationcell&gt; xml element from axes</span>

<span class="sd">   Args:</span>
<span class="sd">     axes (np.array): lattice vectors</span>
<span class="sd">     bconds (str, optional): boundary conditions in x,y,z directions.</span>
<span class="sd">      p for periodic, n for non-periodic, default to &#39;p p p&#39;</span>
<span class="sd">     rckc: long-range cutoff paramter rc*kc, default to 15</span>
<span class="sd">   Return:</span>
<span class="sd">     etree.Element: representing &lt;simulationcell&gt;</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">pad_line</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>  <span class="c1"># allow content to be selected by double clicked</span>
    <span class="k">return</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">line</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>

  <span class="c1"># write primitive lattice vectors</span>
  <span class="n">lat_node</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;parameter&#39;</span><span class="p">,</span> <span class="n">attrib</span><span class="o">=</span><span class="p">{</span>
    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;lattice&#39;</span><span class="p">,</span>
    <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;bohr&#39;</span>
  <span class="p">})</span>
  <span class="n">lat_node</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">arr2text</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>

  <span class="c1"># write boundary conditions</span>
  <span class="n">bconds_node</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;parameter&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;bconds&#39;</span><span class="p">})</span>
  <span class="n">bconds_node</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">pad_line</span><span class="p">(</span><span class="n">bconds</span><span class="p">)</span>

  <span class="c1"># write long-range cutoff parameter</span>
  <span class="n">lr_node</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;parameter&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;LR_dim_cutoff&#39;</span><span class="p">})</span>
  <span class="n">lr_node</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">pad_line</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">rckc</span><span class="p">))</span>

  <span class="c1"># build &lt;simulationcell&gt;</span>
  <span class="n">sc_node</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;simulationcell&#39;</span><span class="p">)</span>
  <span class="n">sc_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lat_node</span><span class="p">)</span>
  <span class="n">sc_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bconds_node</span><span class="p">)</span>
  <span class="n">sc_node</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lr_node</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">sc_node</span></div>

<div class="viewcode-block" id="particle_group_from_pos"><a class="viewcode-back" href="../../../qharv.seed.html#qharv.seed.qmcpack_in.particle_group_from_pos">[docs]</a><span class="k">def</span> <span class="nf">particle_group_from_pos</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">charge</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; construct a &lt;group&gt; in the &lt;particleset&gt; xml element</span>

<span class="sd">   Args:</span>
<span class="sd">     pos (np.array): positions, shape (nptcl, ndim)</span>
<span class="sd">     name (str): name of particle group</span>
<span class="sd">     charge (float): the amount of charge of this particle species</span>
<span class="sd">   Return:</span>
<span class="sd">     etree.Element: &lt;group&gt; including &lt;attrib name=&quot;positions&quot;&gt;</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="s1">&#39;charge&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;keyword charge </span><span class="si">%f</span><span class="s1"> will be overwriten&#39;</span>
    <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39; by </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;charge&#39;</span><span class="p">],</span> <span class="n">charge</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
  <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;charge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">charge</span>
  <span class="n">group</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">,</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">)),</span>
  <span class="p">))</span>
  <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">xml</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">new</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">pos_attrib</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;attrib&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;position&#39;</span><span class="p">,</span>
    <span class="n">datatype</span> <span class="o">=</span> <span class="s1">&#39;posArray&#39;</span><span class="p">,</span>
    <span class="n">condition</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="p">))</span>
  <span class="n">pos_attrib</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">arr2text</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
  <span class="n">group</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos_attrib</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">group</span></div>

<div class="viewcode-block" id="ud_electrons"><a class="viewcode-back" href="../../../qharv.seed.html#qharv.seed.qmcpack_in.ud_electrons">[docs]</a><span class="k">def</span> <span class="nf">ud_electrons</span><span class="p">(</span><span class="n">nup</span><span class="p">,</span> <span class="n">ndown</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; construct the &lt;particleset name=&quot;e&quot;&gt; xml element for electrons</span>

<span class="sd">   Args:</span>
<span class="sd">     nup (int): number of up electrons</span>
<span class="sd">     ndown (int): number of down electrons</span>
<span class="sd">   Return:</span>
<span class="sd">     etree.Element: representing &lt;particleset name=&quot;e&quot;&gt;</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">epset</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;particleset&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;random&#39;</span><span class="p">:</span> <span class="s1">&#39;yes&#39;</span><span class="p">})</span>

  <span class="n">up_group</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span>
    <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">nup</span><span class="p">),</span>
    <span class="s1">&#39;mass&#39;</span><span class="p">:</span> <span class="s1">&#39;1.0&#39;</span>
  <span class="p">})</span>
  <span class="n">dn_group</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span>
    <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">ndown</span><span class="p">),</span>
    <span class="s1">&#39;mass&#39;</span><span class="p">:</span> <span class="s1">&#39;1.0&#39;</span>
  <span class="p">})</span>
  <span class="k">for</span> <span class="n">egroup</span> <span class="ow">in</span> <span class="p">[</span><span class="n">up_group</span><span class="p">,</span> <span class="n">dn_group</span><span class="p">]:</span>
    <span class="n">xml</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="n">egroup</span><span class="p">,</span> <span class="s1">&#39;charge&#39;</span><span class="p">,</span> <span class="s1">&#39; -1 &#39;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">epset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">egroup</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">epset</span></div>

<div class="viewcode-block" id="all_electron_hamiltonian"><a class="viewcode-back" href="../../../qharv.seed.html#qharv.seed.qmcpack_in.all_electron_hamiltonian">[docs]</a><span class="k">def</span> <span class="nf">all_electron_hamiltonian</span><span class="p">(</span><span class="n">elec_name</span><span class="o">=</span><span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="n">ion_name</span><span class="o">=</span><span class="s1">&#39;ion0&#39;</span><span class="p">):</span>
  <span class="n">ee</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;pairpot&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;coulomb&#39;</span><span class="p">,</span>  <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;ElecElec&#39;</span><span class="p">,</span>
    <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">elec_name</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">elec_name</span>
  <span class="p">})</span>
  <span class="n">ei</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;pairpot&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;coulomb&#39;</span><span class="p">,</span>  <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;ElecIon&#39;</span><span class="p">,</span>
    <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">ion_name</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">elec_name</span>
  <span class="p">})</span>
  <span class="n">ii</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;pairpot&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;coulomb&#39;</span><span class="p">,</span>  <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;IonIon&#39;</span><span class="p">,</span>
    <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">ion_name</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">ion_name</span>
  <span class="p">})</span>
  <span class="n">ham</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;hamiltonian&#39;</span><span class="p">)</span>
  <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ham</span><span class="p">,</span> <span class="p">[</span><span class="n">ee</span><span class="p">,</span> <span class="n">ei</span><span class="p">,</span> <span class="n">ii</span><span class="p">])</span>
  <span class="k">return</span> <span class="n">ham</span></div>

<div class="viewcode-block" id="bspline_qmcsystem"><a class="viewcode-back" href="../../../qharv.seed.html#qharv.seed.qmcpack_in.bspline_qmcsystem">[docs]</a><span class="k">def</span> <span class="nf">bspline_qmcsystem</span><span class="p">(</span><span class="n">fh5</span><span class="p">,</span> <span class="n">tmat</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Create Slater-Jastrow system input from pw2qmcpack.x h5 file</span>

<span class="sd">  Args:</span>
<span class="sd">    fh5 (str): path to wf h5 file</span>
<span class="sd">    tmat (np.array): tile matrix</span>
<span class="sd">  Return:</span>
<span class="sd">    qsys (etree.Element): &lt;qmcsystem&gt;</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
  <span class="kn">from</span> <span class="nn">qharv.seed</span> <span class="k">import</span> <span class="n">wf_h5</span>
  <span class="n">ndim0</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># !!!! hard-code for three dimensions</span>
  <span class="n">fp</span> <span class="o">=</span> <span class="n">wf_h5</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fh5</span><span class="p">)</span>
  <span class="n">axes</span><span class="p">,</span> <span class="n">elem</span><span class="p">,</span> <span class="n">charge_map</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">wf_h5</span><span class="o">.</span><span class="n">axes_elem_charges_pos</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
  <span class="n">nelecs</span> <span class="o">=</span> <span class="n">wf_h5</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="s1">&#39;nelecs&#39;</span><span class="p">)</span>
  <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
  <span class="n">natom</span><span class="p">,</span> <span class="n">ndim</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">shape</span>
  <span class="k">assert</span> <span class="n">ndim</span> <span class="o">==</span> <span class="n">ndim0</span>
  <span class="n">nup</span><span class="p">,</span> <span class="n">ndn</span> <span class="o">=</span> <span class="n">nelecs</span>
  <span class="k">if</span> <span class="n">nup</span> <span class="o">!=</span> <span class="n">ndn</span><span class="p">:</span>  <span class="c1"># hard-code for unpolarized for now</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;nup != ndn&#39;</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">tmat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># use primitive cell by default</span>
    <span class="n">tmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>  <span class="c1"># tile supercell</span>
    <span class="kn">from</span> <span class="nn">qharv.inspect.axes_elem_pos</span> <span class="k">import</span> <span class="n">ase_tile</span>
    <span class="n">axes</span><span class="p">,</span> <span class="n">elem</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">ase_tile</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">elem</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">tmat</span><span class="p">)</span>
  <span class="n">spoup</span> <span class="o">=</span> <span class="n">spodn</span> <span class="o">=</span> <span class="s1">&#39;spo_ud&#39;</span>
  <span class="n">psi_name</span> <span class="o">=</span> <span class="s1">&#39;psi0&#39;</span>
  <span class="n">ion_name</span> <span class="o">=</span> <span class="s1">&#39;ion0&#39;</span>
  <span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="c1"># simulationcell</span>
  <span class="n">sc_node</span> <span class="o">=</span> <span class="n">simulationcell_from_axes</span><span class="p">(</span><span class="n">axes</span><span class="p">)</span>
  <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sc_node</span><span class="p">)</span>

  <span class="c1"># particlesets</span>
  <span class="n">ions</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;particleset&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">ion_name</span><span class="p">})</span>
  <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">charge</span> <span class="ow">in</span> <span class="n">charge_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">sel</span> <span class="o">=</span> <span class="n">elem</span> <span class="o">==</span> <span class="n">name</span>
    <span class="n">ion_grp</span> <span class="o">=</span> <span class="n">particle_group_from_pos</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">sel</span><span class="p">],</span> <span class="n">name</span><span class="p">,</span> <span class="n">charge</span><span class="p">)</span>
    <span class="n">ions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ion_grp</span><span class="p">)</span>
  <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ions</span><span class="p">)</span>
  <span class="n">elecs</span> <span class="o">=</span> <span class="n">ud_electrons</span><span class="p">(</span><span class="o">*</span><span class="n">nelecs</span><span class="p">)</span>
  <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elecs</span><span class="p">)</span>

  <span class="c1"># sposet and builder</span>
  <span class="n">tmat_str</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> &#39;</span> <span class="o">*</span> <span class="mi">9</span><span class="p">)</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">tmat</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
  <span class="n">sb</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;sposet_builder&#39;</span><span class="p">,</span> <span class="p">{</span>
      <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;bspline&#39;</span><span class="p">,</span>
      <span class="s1">&#39;href&#39;</span><span class="p">:</span> <span class="n">fh5</span><span class="p">,</span>
      <span class="s1">&#39;tilematrix&#39;</span><span class="p">:</span> <span class="n">tmat_str</span><span class="p">,</span>
      <span class="s1">&#39;twistnum&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
      <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="n">ion_name</span><span class="p">,</span>  <span class="c1"># &quot;Einspline needs the source particleset&quot;</span>
  <span class="p">})</span>
  <span class="n">spo</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;sposet&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;bspline&#39;</span><span class="p">,</span>
    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">spoup</span><span class="p">,</span>
    <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">nup</span><span class="p">),</span>
    <span class="s1">&#39;spindataset&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span><span class="p">}</span>
  <span class="p">)</span>
  <span class="n">sb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spo</span><span class="p">)</span>

  <span class="c1"># determinantset</span>
  <span class="n">updet</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;determinant&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;updet&#39;</span><span class="p">,</span>
    <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">nup</span><span class="p">),</span>
    <span class="s1">&#39;sposet&#39;</span><span class="p">:</span> <span class="n">spoup</span>
  <span class="p">})</span>
  <span class="n">dndet</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;determinant&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;dndet&#39;</span><span class="p">,</span>
    <span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">ndn</span><span class="p">),</span>
    <span class="s1">&#39;sposet&#39;</span><span class="p">:</span> <span class="n">spodn</span>
  <span class="p">})</span>
  <span class="n">sdet</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;slaterdeterminant&#39;</span><span class="p">)</span>
  <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sdet</span><span class="p">,</span> <span class="p">[</span><span class="n">updet</span><span class="p">,</span> <span class="n">dndet</span><span class="p">])</span>
  <span class="n">dset</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;determinantset&#39;</span><span class="p">)</span>
  <span class="n">dset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sdet</span><span class="p">)</span>

  <span class="c1"># wave function</span>
  <span class="n">wf</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;wavefunction&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">psi_name</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;e&#39;</span><span class="p">})</span>
  <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="p">[</span><span class="n">sb</span><span class="p">,</span> <span class="n">dset</span><span class="p">])</span>
  <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wf</span><span class="p">)</span>

  <span class="c1"># hailtonian</span>
  <span class="n">ham</span> <span class="o">=</span> <span class="n">all_electron_hamiltonian</span><span class="p">()</span>
  <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ham</span><span class="p">)</span>
  <span class="n">qsys</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">make_node</span><span class="p">(</span><span class="s1">&#39;qmcsystem&#39;</span><span class="p">)</span>
  <span class="n">xml</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qsys</span><span class="p">,</span> <span class="n">nodes</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">qsys</span></div>

<span class="c1"># ================== level 1: use existing input ===================</span>
<div class="viewcode-block" id="expand_twists"><a class="viewcode-back" href="../../../qharv.seed.html#qharv.seed.qmcpack_in.expand_twists">[docs]</a><span class="k">def</span> <span class="nf">expand_twists</span><span class="p">(</span><span class="n">example_in_xml</span><span class="p">,</span> <span class="n">twist_list</span><span class="p">,</span> <span class="n">calc_dir</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; expand example input xml to all twists in twist_list</span>

<span class="sd">  Naming convention of new inputs:</span>
<span class="sd">    [prefix].g001.twistnum_[itwist].in.xml</span>

<span class="sd">  Args:</span>
<span class="sd">    example_in_xml (str): example QMCPACK input xml file</span>
<span class="sd">    twist_list (list): a list of twist indices</span>
<span class="sd">    calc_dir (str): folder to output new inputs</span>
<span class="sd">  Return:</span>
<span class="sd">    None</span>
<span class="sd">  Examples:</span>
<span class="sd">    &gt;&gt;&gt; expand_twists(&#39;./vmc.in.xml&#39;,range(64),&#39;.&#39;)</span>
<span class="sd">    &gt;&gt;&gt; expand_twists(&#39;./ref/vmc.in.xml&#39;,[0,15,17],&#39;./new&#39;)</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">doc</span>    <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">example_in_xml</span><span class="p">)</span>
  <span class="n">prefix</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//project&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>

  <span class="n">fname_fmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{prefix:s}</span><span class="s1">.</span><span class="si">{gt:s}</span><span class="s1">.twistnum_</span><span class="si">{itwist:d}</span><span class="s1">.in.xml&#39;</span>
  <span class="n">bundle_text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
  <span class="n">bundle_in</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">calc_dir</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.in&#39;</span> <span class="o">%</span> <span class="n">prefix</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">itwist</span> <span class="ow">in</span> <span class="n">twist_list</span><span class="p">:</span>
    <span class="c1"># change twist number</span>
    <span class="n">bb</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//sposet_builder[@type=&quot;bspline&quot;]&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># assume old-style input</span>
      <span class="n">bb</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//determinantset[@type=&quot;bspline&quot;]&#39;</span><span class="p">)</span>
    <span class="n">bb</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;twistnum&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">itwist</span><span class="p">))</span>

    <span class="c1"># construct file name</span>
    <span class="n">gt</span> <span class="o">=</span> <span class="s1">&#39;g&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">itwist</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">fname_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
      <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span><span class="p">,</span>
      <span class="n">gt</span>     <span class="o">=</span> <span class="n">gt</span><span class="p">,</span>
      <span class="n">itwist</span> <span class="o">=</span> <span class="n">itwist</span>
    <span class="p">)</span>
    <span class="n">floc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">calc_dir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
    <span class="n">bundle_text</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fname</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>  <span class="c1"># check if file exists</span>
      <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">floc</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;force to overwrite </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">floc</span><span class="p">)</span>
    <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">floc</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">bundle_in</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bundle_text</span><span class="p">)</span></div>

<div class="viewcode-block" id="bundle_twists"><a class="viewcode-back" href="../../../qharv.seed.html#qharv.seed.qmcpack_in.bundle_twists">[docs]</a><span class="k">def</span> <span class="nf">bundle_twists</span><span class="p">(</span><span class="n">calc_dir</span><span class="p">,</span> <span class="n">fregex</span><span class="o">=</span><span class="s1">&#39;*twistnum_*.in.xml&#39;</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; bundle all twist inputs</span>

<span class="sd">  quick and dirty: `cd $calc_dir; ls &gt; prefix.in`, then edit prefix.in</span>

<span class="sd">  Args:</span>
<span class="sd">    calc_dir (str): calculation directory</span>
<span class="sd">    fregex (str, optional): regular expression for all twists</span>
<span class="sd">  Return:</span>
<span class="sd">    str: bundled input text</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">flist</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">files_with_regex</span><span class="p">(</span><span class="n">fregex</span><span class="p">,</span> <span class="n">calc_dir</span><span class="p">,</span> <span class="n">maxdepth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
  <span class="n">flist</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

  <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
  <span class="k">for</span> <span class="n">floc</span> <span class="ow">in</span> <span class="n">flist</span><span class="p">:</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">floc</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">+=</span> <span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
  <span class="k">return</span> <span class="n">text</span></div>


<div class="viewcode-block" id="disperse"><a class="viewcode-back" href="../../../qharv.seed.html#qharv.seed.qmcpack_in.disperse">[docs]</a><span class="k">def</span> <span class="nf">disperse</span><span class="p">(</span><span class="n">ginp_loc</span><span class="p">,</span> <span class="n">calc_dir</span><span class="p">,</span> <span class="n">execute</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; disperse inputs bundled up in a grouped input</span>

<span class="sd">  Args:</span>
<span class="sd">    ginp_loc (str): location of grouped input e.g. ../runs/dmc/qmc.in</span>
<span class="sd">    calc_dir (str): folder to output new inputs e.g. dmc1</span>
<span class="sd">    execute (bool,optional): perform file I/O, default is False i.e. a dry run</span>
<span class="sd">    overwrite (bool,optional): overwrite existing files, default is False</span>
<span class="sd">  Returns:</span>
<span class="sd">    list: a list of new inputs</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="c1"># path0 is the folder containing the current grouped input</span>
  <span class="n">path0</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">ginp_loc</span><span class="p">)</span>
  <span class="n">calc_dir0</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path0</span><span class="p">)</span>
  <span class="c1"># path  is the folder to contain the dispersed inputs</span>
  <span class="n">path</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path0</span><span class="p">),</span> <span class="n">calc_dir</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">execute</span><span class="p">:</span>  <span class="c1"># make folder if not there</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
      <span class="n">sp</span><span class="o">.</span><span class="n">check_call</span><span class="p">([</span><span class="s1">&#39;mkdir&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">])</span>

  <span class="c1"># for each input in grouped input file, add group text (gt) to project id</span>
  <span class="c1">#  if execute, write input in given folder</span>
  <span class="n">flist</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">ginp_loc</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">ig</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
      <span class="c1"># construct source and target input paths</span>
      <span class="n">infile</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
      <span class="n">floc0</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path0</span><span class="p">,</span> <span class="n">infile</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">floc0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> not found&#39;</span> <span class="o">%</span> <span class="n">floc0</span><span class="p">)</span>
      <span class="n">floc</span>   <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">infile</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">floc</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">overwrite</span><span class="p">)</span> <span class="ow">and</span> <span class="n">execute</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> exists; delete or overwrite &#39;</span> <span class="o">%</span> <span class="n">floc</span><span class="p">)</span>
      <span class="n">flist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">floc</span><span class="p">)</span>

      <span class="c1"># modify prefix</span>
      <span class="n">gt</span> <span class="o">=</span> <span class="s1">&#39;g&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ig</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
      <span class="n">doc</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">floc0</span><span class="p">)</span>
      <span class="n">pnode</span>   <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//project&#39;</span><span class="p">)</span>
      <span class="n">prefix0</span> <span class="o">=</span> <span class="n">pnode</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
      <span class="n">prefix</span>  <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">prefix0</span><span class="p">,</span> <span class="n">gt</span><span class="p">])</span>
      <span class="n">pnode</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">execute</span><span class="p">:</span>
        <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">floc</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>

      <span class="n">ig</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">return</span> <span class="n">flist</span></div>

<div class="viewcode-block" id="set_norb"><a class="viewcode-back" href="../../../qharv.seed.html#qharv.seed.qmcpack_in.set_norb">[docs]</a><span class="k">def</span> <span class="nf">set_norb</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">norb</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; occupy the lowest norb Kohn-Sham orbitals</span>

<span class="sd">  Args:</span>
<span class="sd">    doc (etree.Element): must contain &lt;particleset&gt;, &lt;sposet&gt;, and &lt;det...set&gt;</span>
<span class="sd">    norb (int): number of orbitals to occupy</span>
<span class="sd">  Return:</span>
<span class="sd">    None</span>
<span class="sd">  Effect:</span>
<span class="sd">    doc is modified</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">epset</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//particleset[@name=&quot;e&quot;]&#39;</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">epset</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.//group&#39;</span><span class="p">):</span>  <span class="c1"># &#39;u&#39; and &#39;d&#39;</span>
    <span class="n">group</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">norb</span><span class="p">))</span>

  <span class="n">sposet</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//sposet[@name=&quot;spo_ud&quot;]&#39;</span><span class="p">)</span>
  <span class="n">sposet</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">norb</span><span class="p">))</span>

  <span class="n">detset</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.//determinantset&#39;</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">detset</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.//determinant&#39;</span><span class="p">):</span>
    <span class="n">det</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">norb</span><span class="p">))</span></div>

<div class="viewcode-block" id="set_gc_occ"><a class="viewcode-back" href="../../../qharv.seed.html#qharv.seed.qmcpack_in.set_gc_occ">[docs]</a><span class="k">def</span> <span class="nf">set_gc_occ</span><span class="p">(</span><span class="n">norbl</span><span class="p">,</span> <span class="n">calc_dir</span><span class="p">,</span> <span class="n">fregex_fmt</span><span class="o">=</span><span class="s1">&#39;*twistnum_</span><span class="si">{itwist:d}</span><span class="s1">.in.xml&#39;</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; edit twist inputs in calc_dir according to occupation vector norbl</span>

<span class="sd">  Args:</span>
<span class="sd">    norbl (list): number of occupied orbitals at each twist</span>
<span class="sd">    calc_dir (str): location of twist inputs</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">nocc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">norbl</span><span class="p">)</span>
  <span class="n">wild_fregex</span> <span class="o">=</span> <span class="n">fregex_fmt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{itwist:d}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
  <span class="n">flist</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">files_with_regex</span><span class="p">(</span><span class="n">wild_fregex</span><span class="p">,</span> <span class="n">calc_dir</span><span class="p">)</span>
  <span class="n">ntwist</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">flist</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">nocc</span> <span class="o">!=</span> <span class="n">ntwist</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> occupations given for </span><span class="si">%d</span><span class="s1"> twists&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nocc</span><span class="p">,</span> <span class="n">ntwist</span><span class="p">))</span>

  <span class="k">for</span> <span class="n">itwist</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntwist</span><span class="p">):</span>
    <span class="n">norb</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">norbl</span><span class="p">[</span><span class="n">itwist</span><span class="p">])</span>
    <span class="n">fregex</span> <span class="o">=</span> <span class="n">fregex_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">itwist</span><span class="o">=</span><span class="n">itwist</span><span class="p">)</span>
    <span class="n">fxml</span> <span class="o">=</span> <span class="n">mole</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">fregex</span><span class="p">,</span> <span class="n">calc_dir</span><span class="p">)</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="n">xml</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fxml</span><span class="p">)</span>
    <span class="n">set_norb</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">norb</span><span class="p">)</span>
    <span class="n">xml</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fxml</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span></div>

<div class="viewcode-block" id="set_nwalker"><a class="viewcode-back" href="../../../qharv.seed.html#qharv.seed.qmcpack_in.set_nwalker">[docs]</a><span class="k">def</span> <span class="nf">set_nwalker</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">nwalker</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; set the number of walkers to use in DMC</span>

<span class="sd">  Args:</span>
<span class="sd">    doc (lxml.Element): xml node containing &lt;qmc&gt;</span>
<span class="sd">    nwalker (int): number of walkers</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">nodes</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.//qmc[@method=&quot;vmc&quot;]&#39;</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
    <span class="n">xml</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;samples&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">nwalker</span><span class="p">))</span>
  <span class="n">nodes</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;.//qmc[@method=&quot;dmc&quot;]&#39;</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
    <span class="n">xml</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s1">&#39;targetwalkers&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">nwalker</span><span class="p">))</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
<h3><a href="../../../index.html">Table of Contents</a></h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../qharv.html">qharv package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">qharv</a></li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">qharv 0.0.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Yubo &#34;Paul&#34; Yang.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.2.
    </div>
  </body>
</html>