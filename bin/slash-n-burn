#!/usr/bin/env python
# Author: Yubo "Paul" Yang
# Email: yubo.paul.yang@gmail.com
#
# Script for cleaning temporary files
#  (clear fields for sowninig)

if __name__ == '__main__':
  import sys
  import argparse
  import subprocess as sp

  parser = argparse.ArgumentParser(description='This script looks for files which are expendable for a later QMC calculation. If the "-y" flag is used, then the files are deleted. Progress can be shown using the "-v" flag; however progressbar2 is required. Currently, this script finds temperory files generated by nexus (.upf, vdW_kernel_table) and quantum espresso (wfc,K0000*).')
  parser.add_argument('rundir',type=str,help='folder to clean')
  parser.add_argument('--remove','-y',action='store_true',help='clean')
  parser.add_argument('--verbose','-v',action='store_true',help='show progress, require progressbar2')
  args = parser.parse_args()
  if args.verbose: # import as needed
    import progressbar

  from qharv.reel import mole
  kpoints  = mole.files_with_regex('*K0*',args.rundir,ftype='d')
  pseudos  = mole.files_with_regex('*upf',args.rundir,case=False)
  wfc = mole.files_with_regex('*wfc*',args.rundir)
  vdw = mole.files_with_regex('*vdW_kernel_table',args.rundir)

  # inform
  files2rm = kpoints + pseudos + wfc + vdw
  msg = """
  %d kpoint folders
  %d pseduopotential files
  %d wfc saves
  %d vdW-DF kernel tables """ % (len(kpoints),len(pseudos),len(wfc),len(vdw))
  if len(files2rm) == 0:
    print("no file to remove from %s"%args.rundir)
    sys.exit(0)
  elif (not args.remove):
    print("""ready to remove: %s
add '-y' to proceed with removal""" %msg 
    )
  else:
    print('removing: %s' %msg)
  # end if

  # perform
  if args.remove:
    if args.verbose:
      pbar = progressbar.ProgressBar(max_value=len(files2rm))
    ifile = 0
    for floc in files2rm:
      sp.check_call(['rm','-r',floc])
      if args.verbose:
        pbar.update(ifile+1)
      ifile += 1
    # end for
  # end if
# end __main__
